#!/bin/bash
set -e

# ログファイル設定
LOG_FILE="/var/log/userdata.log"
exec > >(tee -a ${LOG_FILE}) 2>&1

echo "=========================================="
echo "CDK Execution EC2 Setup Started"
echo "Timestamp: $(date)"
echo "=========================================="

# Swap領域の作成（メモリ不足対策）
echo "[0/4] Creating 2GB swap space..."
dd if=/dev/zero of=/swapfile bs=1M count=2048
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
echo '/swapfile none swap sw 0 0' >> /etc/fstab
echo "Swap space created and enabled"
free -m

# Node.js 22.x インストール
echo "[1/4] Installing Node.js 22.x..."
curl -fsSL https://rpm.nodesource.com/setup_22.x | bash -
dnf install -y nodejs

# Node.js バージョン確認
echo "Node.js version: $(node --version)"
echo "npm version: $(npm --version)"

# Node.jsヒープメモリ上限を設定（メモリ不足対策）
echo "export NODE_OPTIONS=\"--max-old-space-size=1536\"" >> /home/ec2-user/.bashrc
echo "NODE_OPTIONS set to increase heap memory limit"

# AWS CDK CLI インストール
echo "[2/4] Installing AWS CDK CLI..."
npm install -g aws-cdk

# CDK バージョン確認
echo "CDK version: $(cdk --version)"

# Git インストール（既にインストール済みの可能性が高いが念のため）
echo "[3/4] Ensuring Git is installed..."
dnf install -y git

echo "=========================================="
echo "CDK Execution EC2 Setup Completed"
echo "Timestamp: $(date)"
echo "=========================================="
echo ""
echo "Next steps:"
echo "1. Connect via Session Manager"
echo "2. Clone the repository"
echo "3. Run: cd containers/docs/day2/cdk && npm install"
echo "4. Run: npx cdk bootstrap"
echo "5. Run: npx cdk deploy -c userName=your-name"
